events {}

http {
  # Allow moderately sized uploads for KB files
  client_max_body_size 50m;

  # Upgrade handling (for websockets/streams)
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  upstream frontend {
    server front-end:3000;
  }

  upstream auth_service {
    server authentication-service:3000;
  }

  upstream broker_service {
    server broker-service:3000;
  }

  upstream mail_service {
    server mail-service:3000;
  }

  upstream logger_service {
    server logger-service:3000;
  }

  upstream flowise_proxy {
    server flowise-proxy:4000;
  }

  upstream flowise_ui {
    server flowise:3000;
  }

  upstream grafana_ui {
    server grafana:3000;
  }

  upstream prometheus_api {
    server prometheus:9090;
  }

  server {
    listen 80;

    # Per-request DNS resolution for changing container IPs
    set $frontend_host front-end;
    set $auth_host authentication-service;
    set $broker_host broker-service;
    set $mail_host mail-service;
    set $logger_host logger-service;
    set $flowise_proxy_host flowise-proxy;
    set $flowise_ui_host flowise;
    set $grafana_host grafana;
    set $prometheus_host prometheus;

    # Common proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    proxy_read_timeout 600s;

    # ---------- Frontend ----------
    location / {
      proxy_pass http://$frontend_host:3000;
    }

    # ---------- Auth API (keeps /auth prefix) ----------
    location /api/auth/ {
      proxy_pass http://$auth_host:3000/auth/;
    }

    # ---------- Broker API ----------
    location /api/broker/ {
      proxy_pass http://$broker_host:3000/;
    }

    # ---------- Mail API ----------
    location /api/mail/ {
      proxy_pass http://$mail_host:3000/;
    }

    # ---------- Logger API ----------
    location /api/logger/ {
      proxy_pass http://$logger_host:3000/;
    }

    # ---------- Flowise Proxy (chat/prediction/KB/internal) ----------
    # Preserve full path so /api/* routes hit the proxy unchanged
    location /api/v1/ {
      proxy_pass http://$flowise_proxy_host:4000;
      proxy_buffering off;
    }

    location /api/chat/ {
      proxy_pass http://$flowise_proxy_host:4000;
      proxy_buffering off;
    }

    location /api/kb/ {
      proxy_pass http://$flowise_proxy_host:4000;
      proxy_buffering off;
    }

    location /api/jobs/ {
      proxy_pass http://$flowise_proxy_host:4000;
    }

    location /internal/jobs/ {
      proxy_pass http://$flowise_proxy_host:4000;
    }

    # ---------- Flowise UI ----------
    location /flowise/ {
      proxy_pass http://$flowise_ui_host:3000/;
    }

    # ---------- Grafana ----------
    location /grafana/ {
      proxy_pass http://grafana_ui/;
    }

    # ---------- Prometheus UI ----------
    location /prometheus/ {
      proxy_pass http://prometheus_api/;
    }
  }
}

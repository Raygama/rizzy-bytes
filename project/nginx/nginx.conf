events {}

http {
  # Use Docker DNS for dynamic container IP resolution when proxy_pass uses variables
  resolver 127.0.0.11 ipv6=off valid=10s;
  resolver_timeout 5s;

  # Allow moderately sized uploads for KB files
  client_max_body_size 50m;

  # Upgrade handling (for websockets/streams)
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  upstream frontend {
    server front-end:3000;
  }

  upstream auth_service {
    server authentication-service:3000;
  }

  upstream broker_service {
    server broker-service:3000;
  }

  upstream mail_service {
    server mail-service:3000;
  }

  upstream logger_service {
    server logger-service:3000;
  }

  upstream flowise_proxy {
    server flowise-proxy:4000;
  }

  upstream flowise_ui {
    server flowise:3000;
  }

  upstream grafana_ui {
    server grafana:3000;
  }

  upstream prometheus_api {
    server prometheus:9090;
  } 

  # Shared auth header passthrough (prefer Authorization header, fallback to token cookie)
  map $cookie_token $auth_cookie {
    default "";
    "~.+" "Bearer $cookie_token";
  }

  map $http_authorization $auth_header {
    default $http_authorization;
    "" $auth_cookie;
  }

  server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _ helpdesk-if.space www.helpdesk-if.space;

    # ACME HTTP-01 (must stay on port 80)
    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      default_type text/plain;
      try_files $uri =404;
    }

    location / {
      return 301 https://$host$request_uri;
    }
  }

  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name helpdesk-if.space www.helpdesk-if.space;

    ssl_certificate /etc/letsencrypt/live/helpdesk-if.space/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/helpdesk-if.space/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # ACME on 443 (not required but harmless for probes)
    location ^~ /.well-known/acme-challenge/ {
      root /var/www/certbot;
      default_type text/plain;
      try_files $uri =404;
    }

    # Common proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    proxy_read_timeout 600s;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # ---------- Frontend ----------
    location / {
      proxy_pass http://frontend;
    }

    # ---------- Auth API (keeps /auth prefix) ----------
    location /api/auth/ {
      proxy_pass http://auth_service/auth/;
    }

    # ---------- Broker API ----------
    location /api/broker/ {
      proxy_pass http://broker_service/;
    }

    # ---------- Mail API ----------
    location /api/mail/ {
      proxy_pass http://mail_service/;
    }

    # ---------- Logger API ----------
    location /api/logger/ {
      proxy_pass http://logger_service/;
    }

    # ---------- Flowise Proxy (chat/prediction/KB/internal) ----------
    # Preserve full path so /api/* routes hit the proxy unchanged
    location /api/v1/ {
      proxy_pass http://flowise_proxy;
      proxy_buffering off;
    }

    location /api/chat/ {
      proxy_pass http://flowise_proxy;
      proxy_buffering off;
    }

    location /api/kb/ {
      proxy_pass http://flowise_proxy;
      proxy_buffering off;
    }
    
    location /api/admin/ {
      proxy_pass http://flowise_proxy;
      proxy_buffering off;
    }

    # ---------- Flowise UI ----------
    location /flowise/ {
      proxy_pass http://flowise_ui/;
    }

    # ---------- Grafana ----------
    location /grafana/ {
      proxy_pass http://grafana_ui/;
    }
  }

  # flowise subdomain (admin-only)
  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name flowise.helpdesk-if.space;

    ssl_certificate /etc/letsencrypt/live/helpdesk-if.space/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/helpdesk-if.space/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;

    # Auth check (admin only)
    location = /_auth_admin {
      internal;

      proxy_pass http://auth_service/api/auth/admin/check;

      proxy_set_header Host $host;
      proxy_set_header Authorization $auth_header;
      proxy_set_header Cookie $http_cookie;

      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
    }

    location @auth_admin_failed {
      return 302 https://helpdesk-if.space;
    }

    location / {
      auth_request /_auth_admin;
      error_page 401 403 = @auth_admin_failed;
      proxy_pass http://flowise_ui/;
      proxy_buffering off;
    }
  }

  # grafana subdomain (admin-only)
  server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name grafana.helpdesk-if.space;

    ssl_certificate /etc/letsencrypt/live/helpdesk-if.space/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/helpdesk-if.space/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_http_version 1.1;

    location = /_auth_admin {
      internal;

      proxy_pass http://auth_service/api/auth/admin/check;

      proxy_set_header Host $host;
      proxy_set_header Authorization $auth_header;
      proxy_set_header Cookie $http_cookie;

      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
    }

    location @auth_admin_failed {
      return 302 https://helpdesk-if.space;
    }

    location / {
      auth_request /_auth_admin;
      error_page 401 403 = @auth_admin_failed;
      proxy_pass http://grafana_ui/;
    }
  }
}

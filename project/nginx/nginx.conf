events {}

http {
  # Allow moderately sized uploads for KB files
  client_max_body_size 50m;

  # Upgrade handling (for websockets/streams)
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  upstream frontend {
    server front-end:3000;
  }

  upstream auth_service {
    server authentication-service:3000;
  }

  upstream broker_service {
    server broker-service:3000;
  }

  upstream mail_service {
    server mail-service:3000;
  }

  upstream logger_service {
    server logger-service:3000;
  }

  upstream flowise_proxy {
    server flowise-proxy:4000;
  }

  upstream flowise_ui {
    server flowise:3000;
  }

  # upstream grafana_ui {
  #   server grafana:3000;
  # }

  # upstream prometheus_api {
  #   server prometheus:9090;
  # }

  server {
    listen 80;

    # Common proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    proxy_read_timeout 600s;

    # ---------- Frontend ----------
    location / {
      proxy_pass http://frontend;
    }

    # ---------- Auth API (keeps /auth prefix) ----------
    location /api/auth/ {
      proxy_pass http://auth_service/auth/;
    }

    # ---------- Broker API ----------
    location /api/broker/ {
      proxy_pass http://broker_service/;
    }

    # ---------- Mail API ----------
    location /api/mail/ {
      proxy_pass http://mail_service/;
    }

    # ---------- Logger API ----------
    location /api/logger/ {
      proxy_pass http://logger_service/;
    }

    # ---------- Flowise Proxy (chat/prediction/KB/internal) ----------
    # Preserve full path so /api/* routes hit the proxy unchanged
    location /api/v1/ {
      proxy_pass http://flowise_proxy;
      proxy_buffering off;
    }

    location /api/chat/ {
      proxy_pass http://flowise_proxy;
      proxy_buffering off;
    }

    location /api/kb/ {
      proxy_pass http://flowise_proxy;
      proxy_buffering off;
    }

    location /api/jobs/ {
      proxy_pass http://flowise_proxy;
    }

    location /internal/jobs/ {
      proxy_pass http://flowise_proxy;
    }

    # ---------- Flowise UI ----------
    location /flowise/ {
      proxy_pass http://flowise_ui/;
    }
  }
}
